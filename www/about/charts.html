title = "Charts"
^L
{% extends templates/about.html %}
{% block page %}
<style>
    .chart-wrapper {
        width: 480px;
        float: left;
    }
    H2 {
        padding-top: 12pt;
    }
    .chart {
        position: relative;
        height: 100px;
    }
    .note {
        font-style: italic;
        font-size: 8pt;
        line-height: 10pt;
        padding-bottom: 12pt;
    }
    .label {
      text-align: center;
      font: normal 7pt/7pt "Lucida Mono", Monaco, monospace;
    }
    rect.bar {
      fill: #2A8F79;
      stroke: 0px;
      shape-rendering: crispEdges;
    }
    .axis path, .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }
    .flag {
      fill: white;
      stroke: #614C3E;
      stroke-width: 2px;
    }
    .flagtext {
      font: normal 7pt/7pt "Lucida Mono", Monaco, monospace;
    }
    .tick {
      stroke: #614C3E;
      stroke-width: 1px;
    }
    .ticktext {
      font: normal 7pt/7pt "Lucida Mono", Monaco, monospace;
    }
</style>

<div class="chart-wrapper">
    <a name="users"></a>
    <h2>Users</h2>
    <p class="note">Anyone who's ever created an account on Gittip</p>
    <div class="chart" id="users-"></div>
    <div class="label">weeks</div>
</div>

<div class="chart-wrapper">
    <a name="funders"></a>
    <h2>Funders</h2>
    <p class="note">People who gave money to other people within Gittip</p>
    <div class="chart" id="funders-"></div>
    <div class="label">weeks</div>
</div>

<div class="chart-wrapper">
    <a name="gifts"></a>
    <h2>Gifts ($)</h2>
    <p class="note">Money transferred within Gittip</p>
    <div class="chart" id="volume-"></div>
    <div class="label">weeks</div>
</div>

<div class="chart-wrapper">
    <a name="cumulative-gifts"></a>
    <h2>Cumulative Gifts ($)</h2>
    <p class="note">Money transferred within Gittip (cumulative)</p>
    <div class="chart" id="cumulative-"></div>
    <div class="label">weeks</div>
</div>

<div class="chart-wrapper newline">
    <a name="charges"></a>
    <h2>Charges ($)</h2>
    <p class="note">Money moved into Gittip via credit card<br /> (minimum
    charge <a
        href="http://blog.gittip.com/post/28158537529/why-were-you-charged-10">upped</a>
    to $10 in week 8)</p>
    <div class="chart" id="charges-"></div>
    <div class="label">weeks</div>
</div>

<div class="chart-wrapper">
    <a name="withdrawals"></a>
    <h2>Withdrawals ($)</h2>

    <p class="note">Money withdrawn from Gittip to a bank account<br />(feature <a
        href="http://blog.gittip.com/post/30116848405/with-payouts-gittip-is-minimally-viable">added</a>
    in week 12)</p>

    <div class="chart" id="withdrawals-"></div>
    <div class="label">weeks</div>
</div>

<script src="http://d3js.org/d3.v3.js"></script>
<script>
    $(document).ready(function()
    {
        var outerHeight = 100;
        var outerWidth  = 480;

        var margin = { top: 20, right: 36, bottom:12 , left: 0 };
        var width = outerWidth - margin.right - margin.left;
        var height = outerHeight - margin.top - margin.bottom;


        // gnarly little function to generate a "flag" with two rounded corners.
        // See: http://www.w3.org/TR/SVG/shapes.html#RectElement for the steps to create the path
        // here we assume rx = ry = r and only apply curves to the right side
        // The effective width is width + r, the effective height is height + r + r
        function flagPath(width, height, r) {
          return "M 0 0 L " + width + " 0 A " + r + " " + r + " 0 0 1 " + 
              (width + r) + " " + r + " L " + (width + r) + " " + height + 
              "A " + r + " " + r + " 0 0 1 " + (width) + " " + (height + r ) + 
              " L 0 " + (height + r) + " Z"; 
        }

        function barChart(data, element, accessor) {
          var svg = d3.select(element).append("svg");
          svg.attr({
            width: outerWidth,
            height: outerHeight
          });

          var g = svg.append("g")
              .attr("transform","translate(" + margin.left + "," + margin.top + ")" );

          var xScale = d3.scale.ordinal()
              .rangeRoundBands([0,width],0)
              .domain(data.map(function(d,i) {return i;} ));
          var yScale = d3.scale.linear()
              .domain([0,d3.max(data, function(d,i) { return accessor(d,i); })])
              .range([height,0]);

          var xAxis = d3.svg.axis()
              .scale(xScale)
              .tickValues([])
              .orient("bottom");
          var yAxis = d3.svg.axis()
              .scale(yScale)
              .ticks(0)
              .orient("left");


          var bars = g.append("g").selectAll(".bar")
              .data(data)
              .enter().append("rect")
              .classed("bar", true)
              .attr("x", function(d,i) { return xScale(i); })
              .attr("width", xScale.rangeBand())
              .attr("y", function(d,i) { return yScale(accessor(d,i)); })
              .attr("height", function(d,i) { 
                return height - yScale(accessor(d,i)); 
              });

          // add the flag to the document last (hidden), so it ends up on top.
          var hoverFlag = g.append("g");
          hoverFlag.style("display","none");

          hoverFlag.append("path")
              .classed("flag", true)
              .attr("d",flagPath(36,10,5));
          var hoverTick = g.append("g");
          hoverTick.style("display","none");

          hoverTick.append("line")
              .classed("tick",true)
              .attr({
                x1: 0,
                y1: 0,
                x2: 0,
                y2: 12
              })

          bars.on("mouseover", function(d,i) {
              hoverFlag.attr("transform","translate(" + [xScale(i),yScale(accessor(d,i)) - 10] + ")")
                  .style("display",null);
              hoverFlag.append("text")
                  .classed("flagtext",true)
                  .attr("transform","translate(3,11)")
                  .text(d3.round(accessor(d,i)));
              hoverTick.attr("transform","translate(" + [xScale(i), height] + ")")
                  .style("display",null);
              hoverTick.append("text")
                  .classed("ticktext",true)
                  .attr("transform","translate(3,11)")
                  .text(i)
          });
          bars.on("mouseout", function() {
              hoverFlag.select("text").remove();
              hoverTick.select("text").remove();
              hoverFlag.style("display","none");
              hoverTick.style("display","none");
          });
        }
        d3.json('https://www.gittip.com/about/paydays.json', function(paydays) {

            paydays.reverse(); // not sure why they're going backwards in time?
                               // TODO: make this a generic sort by start date.
            var transferTotal = 0;
            for(var i=0; i < paydays.length; i++) {
              transferTotal += paydays[i].transfer_volume;
              paydays[i].cumulative = transferTotal;
            }

            barChart(paydays, '#users-',      function(d,i) { return d.nparticipants } );
            barChart(paydays, '#funders-',    function(d,i) { return d.ntippers } );
            barChart(paydays, '#volume-',     function(d,i) { return d.transfer_volume } );
            barChart(paydays, '#cumulative-', function(d,i) { return d.cumulative } );
            barChart(paydays, '#charges-',    function(d,i) { return d.charge_volume; });
            barChart(paydays, '#withdrawals-',function(d,i) { return -d.ach_volume; });
        });
    });
</script>
{% end %}
